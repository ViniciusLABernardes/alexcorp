
<?php

$server="localhost";
$user='root';
$password="Vinileandro0807200323!";
$name='animesite';
$port=3308; $connect=new mysqli($server, $user, $password, $name, $port); if ($connect->connect_error){ die("Connection failed: " . $connect->connect_error);} if ($_SERVER['REQUEST_METHOD']==='GET'){ $userName=$_GET['userName']; $query="SELECT Id, user_name, anime_name, message_text, created_at, likes FROM anime_messages WHERE user_name=? ORDER BY created_at DESC"; $stmt=$connect->prepare($query); if ($stmt){ if ($stmt->bind_param("s", $userName)){ if ($stmt->execute()){ $result=$stmt->get_result(); $messages=array(); while ($row=$result->fetch_assoc()){ $message=array( 'Id'=>$row['Id'], 'user_name'=>$row['user_name'], 'user_profile_pic'=>'./assets/images/usericon.png', 'anime_name'=>$row['anime_name'], 'message_text'=>$row['message_text'], 'created_at'=>$row['created_at'], 'likes'=>$row['likes'], ); $messages[]=$message;} header('Content-Type: application/json'); echo json_encode($messages);} else{ echo "Erro na execução da consulta: " . $stmt->error;} $stmt->close();} else{ echo "Erro na associação de parâmetros: " . $stmt->error;}} else{ echo "Erro na preparação da consulta: " . $connect->error;}}elseif ($_SERVER['REQUEST_METHOD']==='PUT'){ $messageId=$_GET['messageId']; $query="UPDATE anime_messages SET likes=likes + 1 WHERE Id=?"; $stmt=$connect->prepare($query); $stmt->bind_param("i", $messageId); if ($stmt->execute()){ if ($stmt->affected_rows >0){ echo "Curtida registrada com sucesso!";} else{ echo "Nenhuma mensagem encontrada com o ID fornecido.";}} else{ echo "Erro ao registrar a curtida: " . $stmt->error;}}elseif ($_SERVER['REQUEST_METHOD']==='DELETE'){ $messageId=$_GET['messageId']; $query="SELECT likes FROM anime_messages WHERE Id=?"; $stmt=$connect->prepare($query); $stmt->bind_param("i", $messageId); if ($stmt->execute()){ $result=$stmt->get_result(); $row=$result->fetch_assoc(); $likes=$row['likes']; if ($likes >0){ $query="UPDATE anime_messages SET likes=likes - 1 WHERE Id=?"; $stmt=$connect->prepare($query); $stmt->bind_param("i", $messageId); if ($stmt->execute()){ echo "Curtida removida com sucesso!";} else{ echo "Erro ao atualizar o número de curtidas: " . $stmt->error;}} else{ echo "Esta mensagem não possui curtidas para remover.";}} else{ echo "Erro ao obter o número de curtidas da mensagem: " . $stmt->error;}} $connect->close();
?>